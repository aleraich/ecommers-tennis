<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAHEL - Panel de Administración</title>
    <link rel="stylesheet" href="admin.css" />
</head>
<body>
    <header class="top-bar">
        <div class="left">
            <h1 class="brand-name">RAHEL - Admin</h1>
        </div>
        <div class="right">
            <span class="auth-link" id="userGreeting"></span>
            <a href="#" class="auth-link" id="logoutLink">Cerrar sesión</a>
        </div>
    </header>

    <div class="sidebar">
        <ul>
            <li><a href="#dashboard" class="active">Dashboard</a></li>
            <li><a href="#products">Productos</a></li>
            <li><a href="#orders">Pedidos</a></li>
            <li><a href="#users">Usuarios</a></li>
            <li><a href="#inventory">Inventario</a></li>
            <li><a href="#promotions">Promociones</a></li>
            <li><a href="#reports">Reportes</a></li>
            <li><a href="#settings">Configuración</a></li>
        </ul>
    </div>

    <main class="admin-container">
        <section id="dashboard" class="section">
            <h2>Dashboard</h2>
            <p>Bienvenido al panel de administración. Aquí podrás ver un resumen de las métricas de tu tienda (próximamente).</p>
        </section>

        <section id="products" class="section">
            <h2>Añadir Producto</h2>
            <form id="productForm" class="product-form" enctype="multipart/form-data">
                <input type="text" name="name" placeholder="Nombre" required />
                <input type="number" name="price" placeholder="Precio" step="0.01" required />
                <input type="file" name="media" accept="image/jpeg,image/png,video/mp4,video/webm" />
                <input type="text" name="description" placeholder="Descripción (opcional)" />
                <select name="category" required>
                    <option value="" disabled selected>Seleccionar categoría</option>
                    <option value="HOMBRE">HOMBRE</option>
                    <option value="MUJER">MUJER</option>
                    <option value="NIÑO">NIÑO</option>
                    <option value="NIÑA">NIÑA</option>
                    <option value="MARCAS">MARCAS</option>
                    <option value="LO MÁS NUEVO">LO MÁS NUEVO</option>
                    <option value="DÍAS ROJOS">DÍAS ROJOS</option>
                    <option value="DEPORTE">DEPORTE</option>
                </select>
                <button type="submit">Añadir</button>
            </form>
            <h2>Listado de Productos</h2>
            <table id="productTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Precio</th>
                        <th>Media</th>
                        <th>Descripción</th>
                        <th>Categoría</th>
                        <th>Fecha de creación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="productList"></tbody>
            </table>
            <div id="loadingMessage" class="loading-message" style="display: none;">Cargando productos...</div>
            <div id="errorMessage" class="error-message" style="display: none; color: red;"></div>
            <div id="emptyMessage" class="empty-message" style="display: none;">No hay productos disponibles.</div>
        </section>

        <section id="orders" class="section" style="display: none;">
            <h2>Pedidos</h2>
            <p>Gestión de pedidos de clientes (próximamente).</p>
        </section>

        <section id="users" class="section" style="display: none;">
            <h2>Usuarios</h2>
            <p>Gestión de clientes y administradores (próximamente).</p>
        </section>

        <section id="inventory" class="section" style="display: none;">
            <h2>Inventario</h2>
            <p>Control de stock de productos (próximamente).</p>
        </section>

        <section id="promotions" class="section" style="display: none;">
            <h2>Promociones</h2>
            <p>Crear y gestionar descuentos (próximamente).</p>
        </section>

        <section id="reports" class="section" style="display: none;">
            <h2>Reportes</h2>
            <p>Análisis de ventas y usuarios (próximamente).</p>
        </section>

        <section id="settings" class="section" style="display: none;">
            <h2>Configuración</h2>
            <p>Ajustes de la tienda (próximamente).</p>
        </section>
    </main>

    <script>
        // Saludo personalizado y cerrar sesión
        document.getElementById('userGreeting').textContent = `Hola, ${localStorage.getItem('userName') || 'Administrador'}`;
        document.getElementById('logoutLink').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('userName');
            localStorage.removeItem('token');
            localStorage.removeItem('userRole');
            window.location.href = '/';
        });

        // Manejar el formulario de añadir productos
        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const token = localStorage.getItem('token');

            if (!token) {
                alert('Error: No estás autenticado. Por favor, inicia sesión nuevamente.');
                window.location.href = '/';
                return;
            }

            try {
                const res = await fetch('http://localhost:3000/admin/products', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const responseData = await res.json();
                if (!res.ok) {
                    alert(`Error (${res.status}): ${responseData.message || responseData.error || 'No se pudo añadir el producto'}`);
                    return;
                }

                alert('Producto añadido con éxito');
                e.target.reset();
                loadProducts();
            } catch (err) {
                alert('Error de red o servidor: ' + err.message);
                console.error('Error al añadir producto:', err);
            }
        });

        // Cargar productos
        let isLoading = false; // Evitar múltiples recargas
        async function loadProducts() {
            if (isLoading) return; // Prevenir recargas simultáneas
            isLoading = true;

            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const emptyMessage = document.getElementById('emptyMessage');
            const productList = document.getElementById('productList');
            const token = localStorage.getItem('token');

            if (!token) {
                alert('Error: No estás autenticado. Por favor, inicia sesión nuevamente.');
                window.location.href = '/';
                isLoading = false;
                return;
            }

            try {
                loadingMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                emptyMessage.style.display = 'none';
                productList.innerHTML = '';

                const response = await fetch('http://localhost:3000/products', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error ${response.status}: ${errorData.message || 'No se pudieron cargar los productos'}`);
                }

                const products = await response.json();
                console.log('Productos cargados:', products); // Depuración
                loadingMessage.style.display = 'none';

                if (!products || products.length === 0) {
                    emptyMessage.style.display = 'block';
                    isLoading = false;
                    return;
                }

                products.forEach(product => {
                    const row = document.createElement('tr');
                    const createdAt = product.created_at ? new Date(product.created_at).toLocaleString('es-ES', {
                        year: 'numeric', month: '2-digit', day: '2-digit',
                        hour: '2-digit', minute: '2-digit'
                    }) : 'Sin fecha';
                    const mediaPreview = product.media ? 
                        (product.media.endsWith('.mp4') || product.media.endsWith('.webm') ? 
                            `<video src="${product.media}" width="50" controls></video>` : 
                            `<img src="${product.media}" alt="${product.name}" width="50" onerror="this.src='https://via.placeholder.com/50'; this.alt='Error al cargar imagen'; console.log('Error cargando imagen: ${product.media}');">`) : 
                        'Sin media';
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>$${product.price}</td>
                        <td>${mediaPreview}</td>
                        <td>${product.description || 'Sin descripción'}</td>
                        <td>${product.category || 'Sin categoría'}</td>
                        <td>${createdAt}</td>
                        <td><button onclick="deleteProduct(${product.id})">Eliminar</button></td>
                    `;
                    productList.appendChild(row);
                });
            } catch (err) {
                console.error('Error al cargar productos:', err);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                errorMessage.textContent = err.message;
            } finally {
                isLoading = false;
            }
        }

        // Eliminar producto
        async function deleteProduct(id) {
            if (confirm('¿Seguro que quieres eliminar este producto?')) {
                const token = localStorage.getItem('token');

                if (!token) {
                    alert('Error: No estás autenticado. Por favor, inicia sesión nuevamente.');
                    window.location.href = '/';
                    return;
                }

                try {
                    const response = await fetch(`http://localhost:3000/admin/products/${id}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const data = await response.json();
                    if (!response.ok) {
                        alert(`Error (${response.status}): ${data.message || data.error || 'No se pudo eliminar el producto'}`);
                        return;
                    }

                    alert('Producto eliminado');
                    loadProducts();
                } catch (error) {
                    alert('Error de red o servidor: ' + error.message);
                    console.error('Error al eliminar producto:', error);
                }
            }
        }

        // Manejar el menú lateral
        const menuItems = document.querySelectorAll('.sidebar a');
        const sections = document.querySelectorAll('.section');
        let currentSection = 'dashboard';

        menuItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSection = item.getAttribute('href').substring(1);

                if (targetSection === currentSection) return; // Evitar recarga innecesaria

                sections.forEach(section => {
                    section.style.display = 'none';
                });

                document.getElementById(targetSection).style.display = 'block';
                menuItems.forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                currentSection = targetSection;

                if (targetSection === 'products') {
                    loadProducts();
                }
            });
        });

        // Mostrar solo el dashboard por defecto
        document.getElementById('dashboard').style.display = 'block';
    </script>
</body>
</html>